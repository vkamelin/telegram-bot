# Руководство пользователя (Dashboard)

## Вход в систему
1. Создайте администратора:
   ```bash
   php run admin:create
   ```
2. Откройте `http://<host>/dashboard/login` и войдите по email/паролю.

## Сообщения (Messages)
- Раздел Send позволяет отправить:
  - текст, фото, аудио, видео, документ, стикер, анимацию, голосовое, кругляш, медиа‑группу;
  - одному чату, выбранным чатам или всем (в зависимости от настроек панели).
- При отправке медиа учитывайте лимиты размеров Telegram Bot API.

## Файлы (Files)
- Загрузка и просмотр файлов, доступных для последующей отправки ботом.

## Промокоды (Promo Codes)
- Раздел доступен по адресу `/dashboard/promo-codes`.
- Загрузка CSV (`/dashboard/promo-codes/upload`):
  - допустимые типы: `text/csv`, `text/plain`, `application/vnd.ms-excel`;
  - размер ≤ min(`REQUEST_SIZE_LIMIT`, 5MB);
  - первая строка — заголовок с колонкой `code` (опционально `expires_at`, `meta`).
  - по завершении отображаются счётчики «импортировано / пропущено (дубликаты)».
- Список кодов: фильтры по статусу, батчу и поиску по `code`, пагинация 20–50.
- Выдача: рядом с кодом укажите `telegram_user_id` и нажмите «Выдать». Выдача проверяет срок действия и статус и пишет запись в отчёт.
- Отчёт: `/dashboard/promo-codes/issues` — фильтры по дате и `telegram_user_id`, кнопка «Экспорт CSV» сохраняет текущую выборку.
- Батчи: `/dashboard/promo-codes/batches` — агрегаты по статусам (available/issued/expired) и total.

## Обновления (Updates)
- Просмотр последних апдейтов, типов и статусов обработки.

## Оплаты (Payments)
- Встроенная поддержка Telegram Payments: отправка инвойсов и наблюдение событий.
- Разделы Dashboard:
  - `/dashboard/invoices/create` — отправка инвойса (`sendInvoice`).
  - `/dashboard/pre-checkout` — список pre-checkout событий.
  - `/dashboard/shipping` — список shipping-запросов.

### Как отправить инвойс (sendInvoice)
1. Откройте `/dashboard/invoices/create`.
2. Заполните поля:
   - `chat_id` — ID получателя (можно задать по умолчанию `DEFAULT_CHAT_ID` в .env).
   - `title`, `description` — заголовок и описание заказа.
   - `payload` — ваш служебный идентификатор заказа/корзины.
   - `provider_token` — токен платежного провайдера (из @BotFather).
   - `currency` — валюта (например, `USD`, `EUR`, `RUB`).
   - `prices` — JSON массив `LabeledPrice` из Bot API (в минимальных единицах):
     Пример: `[{"label":"Item","amount":1990}]`.
3. Опционально включите:
   - `need_name`, `need_phone_number`, `need_email` — запросить у пользователя данные.
   - `need_shipping_address` — запросить адрес доставки.
   - `is_flexible` — гибкая цена (вызовет shipping query, требуется ответ с вариантами доставки).
4. Отправьте форму — инвойс попадет в очередь и будет отправлен ботом.

После подтверждения оплаты пользователем бот получит `pre_checkout_query` и ответит на него автоматически (ок = true). Эти события пишутся в таблицу `tg_pre_checkout` и видны в `/dashboard/pre-checkout`.

Если включена доставка (`need_shipping_address`/`is_flexible`), при вводе адреса Telegram пришлет `shipping_query`. Базовый обработчик отвечает `ok=true` без вариантов доставки. Для реальной доставки задайте варианты в `app/Handlers/Telegram/ShippingQueries/DefaultShippingQueryHandler.php` (метод `answerShippingQuery(...)`).

Примечание: Дашборды используют таблицы `tg_pre_checkout` и `tg_shipping_queries`. Все поступающие события автоматически сохраняются туда.

## Сессии и логи
- Просмотр активных сессий для панели.
- Просмотр логов и быстрый поиск по ним.

## Советы по безопасности
- Используйте HTTPS.
- Не включайте `APP_DEBUG` в проде.
- Ограничьте доступ к панели с помощью VPN/IP‑фильтров, если это возможно.
