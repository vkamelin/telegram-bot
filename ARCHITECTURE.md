# РђСЂС…РёС‚РµРєС‚СѓСЂР° Рё РєР»СЋС‡РµРІС‹Рµ СЂРµС€РµРЅРёСЏ

## РћР±Р·РѕСЂ
- РњРёРЅРёРјР°Р»РёСЃС‚РёС‡РЅС‹Р№ HTTPвЂ‘СЃР»РѕР№ РЅР° Slim 4.
- Р”РІРµ Р·РѕРЅС‹ РјР°СЂС€СЂСѓС‚РѕРІ: API (`/api/*`) Рё Dashboard (`/dashboard/*`).
- Р‘РµР· ORM: РїСЂСЏРјРѕР№ PDO СЃ РїРѕРґРіРѕС‚РѕРІР»РµРЅРЅС‹РјРё РІС‹СЂР°Р¶РµРЅРёСЏРјРё.
- Р—Р°С‰РёС‚Р°: JWT, CSRF, RateвЂ‘Limit, Security Headers, РѕРіСЂР°РЅРёС‡РµРЅРёРµ СЂР°Р·РјРµСЂР° С‚РµР»Р° Р·Р°РїСЂРѕСЃР°, RFC 7807.
- Р¤РѕРЅРѕРІС‹Рµ РІРѕСЂРєРµСЂС‹: long polling Telegram, РѕР±СЂР°Р±РѕС‚С‡РёРє РѕР±РЅРѕРІР»РµРЅРёР№, РїР»Р°РЅРёСЂРѕРІС‰РёРє СЂР°СЃСЃС‹Р»РѕРє, СѓС‚РёР»РёС‚Р°СЂРЅС‹Рµ Р·Р°РґР°С‡Рё.
- Redis (РѕРїС†РёРѕРЅР°Р»СЊРЅРѕ): С…СЂР°РЅРµРЅРёРµ РѕС„С„СЃРµС‚Р° long polling Рё РїСЂР°РІРёР» С„РёР»СЊС‚СЂР°С†РёРё Р°РїРґРµР№С‚РѕРІ.

## РџРѕС‚РѕРє РѕР±СЂР°Р±РѕС‚РєРё Р·Р°РїСЂРѕСЃР°
1. Р’С…РѕРґ РІ `public/index.php`, Р·Р°РіСЂСѓР·РєР° `.env`, СЃР±РѕСЂРєР° `config`.
2. РЎРѕР·РґР°РЅРёРµ SlimвЂ‘РїСЂРёР»РѕР¶РµРЅРёСЏ Рё СЂРµРіРёСЃС‚СЂР°С†РёСЏ Middleware (СЃРІРµСЂС…Сѓ РІРЅРёР·):
   - `RequestIdMiddleware` вЂ” XвЂ‘RequestвЂ‘Id, РєРѕСЂСЂРµР»СЏС†РёСЏ Р»РѕРіРѕРІ.
   - `RequestSizeLimitMiddleware` вЂ” Р·Р°С‰РёС‚Р° РѕС‚ СЃР»РёС€РєРѕРј Р±РѕР»СЊС€РёС… С‚РµР».
   - `BodyParsingMiddleware` вЂ” РїР°СЂСЃРёРЅРі JSON/С„РѕСЂРјвЂ‘РґР°РЅРЅС‹С….
   - `SecurityHeadersMiddleware` вЂ” CORS + Р±Р°Р·РѕРІС‹Р№ CSP + XвЂ‘Headers.
   - `ErrorMiddleware` вЂ” РµРґРёРЅС‹Р№ РѕР±СЂР°Р±РѕС‚С‡РёРє РѕС€РёР±РѕРє (RFC 7807 JSON).
3. Р“СЂСѓРїРїС‹ РјР°СЂС€СЂСѓС‚РѕРІ:
   - Dashboard `/dashboard/*`: СЃРµСЃСЃРёРё + CSRF + Auth (Р»РѕРіРёРЅ/Р»РѕРіР°СѓС‚, UIвЂ‘С„СѓРЅРєС†РёРё).
   - API `/api/*`: JWT + RateвЂ‘Limit (REST СЌРЅРґРїРѕРёРЅС‚С‹).
4. РћС‚РІРµС‚ СЃРµСЂРёР°Р»РёР·СѓРµС‚СЃСЏ С‡РµСЂРµР· `Helpers\Response` (json / problem+json).

## РљРѕРЅС‚СЂРѕР»Р»РµСЂС‹
- `Controllers\Dashboard\*` вЂ” СЃС‚СЂР°РЅРёС†С‹ РїР°РЅРµР»Рё (Messages, Files, Updates, Users, Logs, Рё С‚. Рї.). Р Р°Р±РѕС‚Р°СЋС‚ СЃ СЃРµСЃСЃРёРµР№ Рё CSRF.
- `Controllers\Api\*` вЂ” Health, Auth (login/refresh), Me, Users. Р Р°Р±РѕС‚Р°СЋС‚ СЃ JWT Рё РІРѕР·РІСЂР°С‰Р°СЋС‚ JSON.

## Middleware
- `ErrorMiddleware(bool $debug)` вЂ” РїСЂРµРѕР±СЂР°Р·СѓРµС‚ РёСЃРєР»СЋС‡РµРЅРёСЏ РІ RFC 7807 (РїСЂРё debug вЂ” СЂР°СЃС€РёСЂРµРЅРЅР°СЏ РґРёР°РіРЅРѕСЃС‚РёРєР°).
- `RequestIdMiddleware` вЂ” РіРµРЅРµСЂРёСЂСѓРµС‚/РїРµСЂРµРґР°С‘С‚ `X-Request-Id`.
- `RequestSizeLimitMiddleware(int $bytes)` вЂ” 413 РїСЂРё РїСЂРµРІС‹С€РµРЅРёРё Р»РёРјРёС‚Р° С‚РµР»Р°.
- `SecurityHeadersMiddleware` вЂ” CORS (origins/methods/headers), CSP (script/style/font/connect), Р±РµР·РѕРїР°СЃРЅС‹Рµ Р·Р°РіРѕР»РѕРІРєРё.
- `SessionMiddleware` вЂ” РїРѕРґРґРµСЂР¶РєР° СЃРµСЃСЃРёР№ РґР»СЏ Dashboard.
- `CsrfMiddleware` вЂ” CSRFвЂ‘С‚РѕРєРµРЅС‹ РІ С„РѕСЂРјР°С… Dashboard.
- `JwtMiddleware` вЂ” РІР°Р»РёРґР°С†РёСЏ JWT РґР»СЏ Р·Р°С‰РёС‰С‘РЅРЅС‹С… APIвЂ‘РјР°СЂС€СЂСѓС‚РѕРІ.
- `RateLimitMiddleware` вЂ” Р»РёРјРёС‚С‹ РЅР° IP/РїРѕР»СЊР·РѕРІР°С‚РµР»СЏ.
- `TelegramInitDataMiddleware($botToken)` вЂ” РїСЂРѕРІРµСЂРєР° РїРѕРґРїРёСЃРё `initData` РёР· Telegram Mini App.

## РҐРµР»РїРµСЂС‹ Рё СЃРµСЂРІРёСЃС‹
- `Database` вЂ” singleton PDO.
- `Response` вЂ” json/problem РѕС‚РІРµС‚С‹.
- `Logger` вЂ” РѕР±С‘СЂС‚РєР° РЅР°Рґ Monolog.
- `Push` вЂ” РѕС‚РїСЂР°РІРєР° СЃРѕРѕР±С‰РµРЅРёР№ РІ Telegram (РІРєР»СЋС‡Р°СЏ РіСЂСѓРїРїС‹ РјРµРґРёР°).
- `MediaBuilder` вЂ” СѓРґРѕР±РЅР°СЏ СЃР±РѕСЂРєР° `InputMedia*` РґР»СЏ РіСЂСѓРїРї РјРµРґРёР°.
- `RedisHelper`/`RedisKeyHelper` вЂ” РґРѕСЃС‚СѓРї Рє Redis Рё РєР»СЋС‡Р°Рј.
- `RefreshTokenService` вЂ” СѓРїСЂР°РІР»РµРЅРёРµ refreshвЂ‘С‚РѕРєРµРЅР°РјРё.
- `MessageStorage`, `FileService`, `Path`, `View`, `JsonHelper` вЂ” РІСЃРїРѕРјРѕРіР°С‚РµР»СЊРЅС‹Рµ СѓС‚РёР»РёС‚С‹.
- `Telemetry` вЂ” Р·Р°РіР»СѓС€РєР°/С‚РѕС‡РєР° СЂР°СЃС€РёСЂРµРЅРёСЏ РґР»СЏ РјРµС‚СЂРёРє/С‚СЂРµР№СЃРёРЅРіР°.

## Telegram: РѕР±СЂР°Р±РѕС‚РєР° РѕР±РЅРѕРІР»РµРЅРёР№
- `workers/longpolling.php` СЃС‡РёС‚С‹РІР°РµС‚ Р°РїРґРµР№С‚С‹ СЃ РїРѕРјРѕС‰СЊСЋ `getUpdates`.
- `Telegram\UpdateFilter` СЂРµС€Р°РµС‚, РѕР±СЂР°Р±Р°С‚С‹РІР°С‚СЊ Р»Рё Р°РїРґРµР№С‚ (РїРѕ С‚РёРїР°Рј, С‡Р°С‚Р°Рј, РєРѕРјР°РЅРґР°Рј). РСЃС‚РѕС‡РЅРёРє РїСЂР°РІРёР» вЂ” `.env` РёР»Рё RedisвЂ‘РјРЅРѕР¶РµСЃС‚РІР° (СЃРј. `docs/update-filter.md`).
- Р”Р»СЏ РєР°Р¶РґРѕРіРѕ РїСЂРёРЅСЏС‚РѕРіРѕ Р°РїРґРµР№С‚Р° С„РѕСЂРєРѕРј Р·Р°РїСѓСЃРєР°РµС‚СЃСЏ `workers/handler.php`, С‡С‚РѕР±С‹ РЅРµ Р±Р»РѕРєРёСЂРѕРІР°С‚СЊ РїСЂРё РґР»РёС‚РµР»СЊРЅРѕР№ РѕР±СЂР°Р±РѕС‚РєРµ.
- Р”РѕРїРѕР»РЅРёС‚РµР»СЊРЅРѕ РµСЃС‚СЊ РІРѕСЂРєРµСЂС‹ РґР»СЏ GPT Рё РѕС‚Р»РѕР¶РµРЅРЅС‹С… СЂР°СЃСЃС‹Р»РѕРє.

## Р”Р°РЅРЅС‹Рµ Рё РјРёРіСЂР°С†РёРё
- РњРёРіСЂР°С†РёРё вЂ” Phinx (`php run migrate:create|run|rollback`).
- РњРёРЅРёРјР°Р»СЊРЅС‹Рµ С‚Р°Р±Р»РёС†С‹: РїРѕР»СЊР·РѕРІР°С‚РµР»Рё (Dashboard), СЂРµС„СЂРµС€вЂ‘С‚РѕРєРµРЅС‹, Р»РѕРі/Р¶СѓСЂРЅР°Р» РѕР±РЅРѕРІР»РµРЅРёР№ Рё СЃР»СѓР¶РµР±РЅС‹Рµ РґР°РЅРЅС‹Рµ РґР»СЏ СЂР°СЃСЃС‹Р»РѕРє Рё С„Р°Р№Р»РѕРІ. Р”РµС‚Р°Р»Рё вЂ” РїРѕ РјРёРіСЂР°С†РёСЏРј РІ `database/`.

## РћС€РёР±РєРё Рё РѕС‚РІРµС‚С‹
- Р•РґРёРЅС‹Р№ С„РѕСЂРјР°С‚ РѕС€РёР±РѕРє вЂ” RFC 7807: `application/problem+json` СЃ РїРѕР»СЏРјРё `type`, `title`, `status`, `detail`, `instance`.
- РЈСЃРїРµС€РЅС‹Рµ РѕС‚РІРµС‚С‹ вЂ” `application/json` СЃ РєРѕРЅСЃРёСЃС‚РµРЅС‚РЅС‹РјРё СЃС‚СЂСѓРєС‚СѓСЂР°РјРё (`items`, `meta`, Рё С‚. Рї.).

## Р РµС€РµРЅРёСЏ Рё РєРѕРјРїСЂРѕРјРёСЃСЃС‹
- Р‘РµР· ORM: РјРµРЅСЊС€Рµ РјР°РіРёРё, Р±РѕР»СЊС€Рµ РєРѕРЅС‚СЂРѕР»СЏ, РїСЂРѕС‰Рµ РѕРЅР±РѕСЂРґРёРЅРі.
- Р¤РѕСЂРє РїСЂРѕС†РµСЃСЃРѕРІ РІ long polling: СѓРїСЂРѕС‰Р°РµС‚ РєРѕРЅРєСѓСЂРµРЅС†РёСЋ, РЅРѕ С‚СЂРµР±СѓРµС‚ Р°РєРєСѓСЂР°С‚РЅРѕСЃС‚Рё СЃ СЂРµСЃСѓСЂСЃР°РјРё.
- Redis вЂ” РѕРїС†РёРѕРЅР°Р»СЊРЅРѕ: РїСЂРѕРµРєС‚ РЅРµ Р¶С‘СЃС‚РєРѕ Р·Р°РІРёСЃРёС‚, РЅРѕ РёСЃРїРѕР»СЊР·СѓРµС‚, РєРѕРіРґР° РґРѕСЃС‚СѓРїРµРЅ.
- CSP РЅР°СЃС‚СЂРѕРµРЅ РєРѕРЅСЃРµСЂРІР°С‚РёРІРЅРѕ РґР»СЏ CDNвЂ‘Р±РёР±Р»РёРѕС‚РµРє Dashboard; РїСЂРё РЅРµРѕР±С…РѕРґРёРјРѕСЃС‚Рё СѓР¶РµСЃС‚РѕС‡Р°Р№С‚Рµ/РїРµСЂРµРІРѕРґРёС‚Рµ РЅР° selfвЂ‘С…РѕСЃС‚РёРЅРі.


### UTM отчёт

- Контроллер: `App\\Controllers\\Dashboard\\UtmController`.
- Маршруты: `GET /dashboard/utm`, `POST /dashboard/utm` (в группе Dashboard под Auth+CSRF+Session).
- Источник данных: `tg_pre_checkout` (Telegram Payments pre-checkout), связь по `from_user_id` > `telegram_users.user_id`.
- Агрегация: `SUM(total_amount)` по `telegram_users.utm`; пустые UTM отображаются как `(no utm)`.
- Единицы: суммы остаются в минимальных единицах валюты (копейки/центы).
